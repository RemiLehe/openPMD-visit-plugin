OpenPMD plugin for VisIt
========================

#### Table of Contents
1. [Presentation](#Presentation)
2. [Repository and code structure](#Repository-and-code-structure)
3. [Installation](#Installation)
4. [To be implented/improved](#To-be-implemented/improved)

## Presentation
-------------------

This repository contains the sources for development of an OpenPMD plugin for the visualization software [VisIt](https://wci.llnl.gov/simulation/computer-codes/visit).

## Repository and code structure
------------------------------------

#### Files

This repository contains:

- the C++ source files
- an xml file `OpenPMD.xml` essential for building the plugin
- a Doxygen documentation (in the directory `/Doxygen`) that describes the different classes
- this `README.md` file

Sources are composed of files generated by Visit:

- `avtOpenPMDFileFormat.C`: class for reading and converting file format in vtk
- `OpenPMDEnginePluginInfo.C`
- `OpenPMDMDServerPluginInfo.C`
- `OpenPMDCommonPluginInfo.C`
- `OpenPMDPluginInfo.C`

And external C++ classes developped for reading OpenPMD files:

- `PMDFile.C`: Open, scan and print OpenPMD file structures
- `PMDiteration.C`: class for the iteration groups
- `PMDField.C`: class for the field groups
- `PMDParticle.C`: class for the particle groups

#### How works this plugin

Visit plugins basically read outputs with some specific code or data formats to convert them internally into vtk readable data.

![alt text](./Doxygen/images/class_description.png "Classes")

#### How to generate the Doxygen documentation

First, download and install [Doxygen](http://www.stack.nl/~dimitri/doxygen/download.html).

You can create the documentation by command line ([see this page for more information](https://www.stack.nl/~dimitri/doxygen/manual/doxygen_usage.html))

```
doxygen Doxygen/Doxyfile
```

You can also use the GUI frontend. Open `Doxygen/Doxyfile`, go to `Run`, click on `Run Doxygen` and finally `Show HTML output`.

## Installation
---------------------

For more information about how to generate install a plugin, please, consider the following links:

- [Getting Data Into Visit (official pdf)](https://wci.llnl.gov/content/assets/docs/simulation/computer-codes/visit/GettingDataIntoVisIt2.0.0.pdf)
- [NERSC Visit presentation and instructions](http://www.nersc.gov/users/data-analytics/data-visualization/visit-2/)

Visit contains a series of tools that makes it easy to create and generate plugins. Without going to the details, we will use one of them (`xml2cmake`) to install this plugin. These tools are located in the directory `<Visit application directory>/Contents/Resources/bin/`.

You also need to install [cmake](https://cmake.org/download/).

#### MacOs

First, download and install [VisIt](https://wci.llnl.gov/simulation/computer-codes/visit/downloads). You can install it from the sources but if you only want to use it, we recommend to use the .dmg image for MacOs.

On MacOs, you can choose to install the plugin only for you or all users.
For this aim, we will first use the xml2cmake tool located in `<Visit application directory>/Contents/Resources/bin/`.
We recommend to add an alias in your `~/.profile`.

To install the plugin for you:

```
xml2cmake OpenPMD.xml
```

In this case, the compiled library will be generated in the directory `~/.visit/`.

To install the plugin for all users:

```
xml2cmake -public -clobber OpenPMD.xml
```

In this case, the plugin will be located where you have installed VisIt. If you used the .dmg image, you will find the files in:

```
/Applications/VisIt.app/Contents/Resources/<VisIt version>/darwin-x86_64/plugins/databases/
```

This step generates the file `CMakeLists.txt` in the source directory.

Then, prepare the makefile by doing

```
cmake -DCMAKE_BUILD_TYPE:STRING=Debug
```

This step generates the files `CMakeFiles`, `CMakeCache.txt` and `cmake_install.cmake`.

To compile and generates the library:

```
make
```

You have almost finished, make sure that the libraries are well generated in their corresponding directories. You should be able to find the files `libEOpenPMDDatabase_ser.dylib`, `libMOpenPMDDatabase.dylib`, `libEOpenPMDDatabase_par.dylib`.

#### NERSC

To use Visit on NERSC machines, it is recommended to run Visit on your local computer in client-server mode. Intructions can be found [by clicking on this link](http://www.nersc.gov/users/data-analytics/data-visualization/visit-2/).

First, setup your environment:

```
module swap PrgEnv-intel PrgEnv-gnu-VisIt
module unload darshan
module unload craype
```

Then, load the visit module:

```
module load visit/<your favorite version>
```

Then load the last version of cmake:

```
module load cmake/<the last version number>
```

Then, enter to generate the file `CMakeLists.txt`:

```
xml2cmake OpenPMD.xml
```

If you have the permission, you can create a common installation by doing:

```
xml2cmake -public -clobber OpenPMD.xml
```

Then, prepare the makefile by doing

```
cmake -DCMAKE_BUILD_TYPE:STRING=Debug
```

This step generates the files `CMakeFiles`, `CMakeCache.txt` and `cmake_install.cmake`.

To compile and generates the library:

```
make
```

The libraries (`libEOpenPMDDatabase_par.so`, `libEOpenPMDDatabase_ser.so`, `libIOpenPMDDatabase.so`, `libMOpenPMDDatabase.so`) are located in the following directory:

```
/global/homes/<first login letter>/<login>/.visit/<VisIt version>/linux-x86_64/plugins/databases/
```

#### Ubuntu using the sources

In this section, we present how to install OpenPMD with the VisIt sources.

First, you need to install the following packages

```
sudo apt-get install subversion gcc gdb valgrind cmake
sudo apt-get install mpich
sudo apt-get install libgl1-mesa-dev
sudo apt-get install mesa-utils
sudo apt-get install libxt-dev
sudo apt-get install freeglut3-dev
```

In order to test that OpenGL is well installed, the following command will
launch a small test window.

```
glxgears
```

If you get this error during the installation of VisIt:
```
src/freeglut_internal.h:111:39: fatal error: X11/extensions/XInput.h: No such file or directory
```

You will have to do the following operation:
```
cd /usr/include/X11/extensions && sudo ln -s XI.h XInput.h
```

Create a directory for VisIt where you want to make the installation
(for instance your home directory).

```
mkdir visit
cd visit
```

Then, download useful VisIt files from the svn repository:

```
svn co http://visit.ilight.com/svn/visit/trunk/src/
svn co http://visit.ilight.com/svn/visit/trunk/test/
svn co http://visit.ilight.com/svn/visit/trunk/data
```

Then create the directory `deps`:

```
mkdir deps
cd deps
```

Build the files for VisIt:
```
../src/svn_bin/build_visit --system-cmake --python --hdf5 --szip --zlib --no-visit --parallel --makeflags -j8 --no-pyside --console --arch x86_64
```

Copy the OpenPMD plugin in the VisIt database:

```
cd src/databases
git clone OpenPMD repository
```

You can rename the plugin folder like OpenPMD. 
```
mv openpmd-visit-plugin OpenPMD
```

Check that `/CMakeLists.txt` is well configured. For this aim, look at the `CMakeLists.txt` file of the other plugins.

Prepare the makefile:

```
cd visit/build
cmake -DVISIT_CONFIG_SITE=../deps/ubuntu-VirtualBox.cmake -DCMAKE_BUILD_TYPE=Debug -DCMAKE_INSTALL_PREFIX=../install  ../src
```

Make VisIt:

```
make -j 8
```

Use this command to launch VisIt with Valgrind:

```
./bin/visit -xterm -valgrind engine_ser
```

## Using Visit with openPMD
-------------------------

#### MacOs

Once you have installed the OpenPMD viewer, Visit will automatically recognize it.

To start Visit, you can use the launcher but we recommend to start Visit by command line:

```
/Applications/VisIt.app/Contents/MacOS/VisIt -np <number of cores>
```

You can specify the number of cores you want to use in parallel with VisIt.
OpenPMD files are read and treated in parallel if more than one core are used.

## To be implemented/improved
-------------------------

- The plugin does not read all group and dataset attributes. More attribute readers need to be implemented although the necessary ones for visualization are present.
- The plugin does not take into account dataset of mass or charge (it only works when these are constant).
- Field axis labels, fieldBoudary conditions are not read properly.
- For Particles, 2D is partially implemented (depends on the components).
- Debugging curvilinear meshes for cylindrical geometry.
- Implementing Fortran order, only C order is taken into account
- Improving Exception output.
- Read files in parallel using ADIOS.